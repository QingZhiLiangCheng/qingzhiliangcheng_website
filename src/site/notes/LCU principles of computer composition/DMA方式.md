---
{"dg-publish":true,"permalink":"/LCU principles of computer composition/DMA方式/","dgPassFrontmatter":true,"noteIcon":"","created":"2024-11-22T19:43:45.730+08:00","updated":"2025-03-30T15:06:59.852+08:00"}
---


### DMA方式的特点
#### DMA和程序中断两种方式的数据通路
 ![Pasted image 20241122194741.png|500](/img/user/accessory/Pasted%20image%2020241122194741.png)
 事实上，程序中断方式其实还是通过CPU作为一个缓冲，然后转存到主存中
 不管是输入存入主存还是从主存读取输出到IO设备，都需要一个叫ACC的寄存器（其他机器可能是不一样的寄存器）
 在不需要IO设备或者是数据准备的时候，CPU和IO设备是并行工作的，但是一旦数据准备好了，CPU必须中断正在执行的程序，执行中断服务程序
 
 DMA方式直接建立了主存和DMA接口的通路
#### DMA与主存交换数据的三种工作方式
1. 停止CPU访问主存
	在数据传输的过程中，总线的控制权和内存的访问权都交给了DMA接口，控制简单，而且适合大量的数据进行传输
	这个过程中CPU不能访问存储器，CPU不能使用总线   如果指令缓冲区有指令，那么CPU就可以继续执行自己的程序

	但是数据传输过程中，是一个字一个字的传输的，传输的间隔可能会是比较长的时间（图中蓝线的部分），可能会超过一个主存周期，这一整个蓝线的过程中，DMA会有很长的一段时间没有使用主存，但是主存的访问权不在CPU这儿
	![Pasted image 20241122201020.png|400](/img/user/accessory/Pasted%20image%2020241122201020.png)
2. 周期挪用（周期窃取）
	解决了上面提到的问题
	在这种方法中，DMA占用一个或者几个内存访问周期完成数据的传输
	在数据传输的间隔 和 数据准备阶段，DMA接口放弃对内存的使用权
	MDA访问主存有三种可能
		- CPU此时不访存
		- CPU正在访存 ：DMA只能等
		- CPU和DMA同时请求访存：DMA优先（因为DMA上连接的都是高速设备）
	![Pasted image 20241122202934.png|400](/img/user/accessory/Pasted%20image%2020241122202934.png)
	这个图很形象的显示了周期挪用和周期窃取
3. DMA和CPU交替访问内存
	将CPU工作周期范围C1和C2两部分
	C1专供DMA访存
	C2专供CPU访存
	这样就不用DMA发出申请了 也不需要归还
	![Pasted image 20241122203316.png|400](/img/user/accessory/Pasted%20image%2020241122203316.png)


### DMA接口的功能和组成
DMA接口的功能：
1. 向CPUI申请DMA传送
2. 处理总线控制权的转交
3. 管理系统总线、控制数据传输
4. 确定 数据传送的 首地址和长度
5. 修正传送过程中的数据地址和长度
6. 传输结束时，给出操作完成信号

DMA接口组成：
宏观上总体框图：
CPU会告诉DAM接口从主存的哪个地址开始传输，DMA就需要一个地址寄存器AR
DMA需要知道传输的数据量：计数器
没传输一个值（假设编址单位一样，其实就是间隔一样 比如都是int） 那么AR就会+1  WC是补码 从-n（假设n位） 也是+1
外部要存储进机器的数据 和 输出的数据 都要暂存在一个数据缓冲器当中：BR
设备地址寄存器DAR：1. 供设备选择电路使用，看一下这次访问的设备是不是这个接口当前连接的设备，是否有dma接口管理 2. 比如硬盘当中的柱面号磁道号扇区号
AR通过地址线把要访问的内存的地址送给储存
数据线 连接AR WC DAR
外部设备和数据缓冲器直接相连
输入和输出的过程需要DMA控制逻辑进行控制
外部设备如果要进行DMA传输，要想DMA控制逻辑 发出 请求信号 DREQ
DMA控制器对设备给出应答信号：DACK
如果DMA要占用总线的话，DMA控制器要像CPU发出总线使用的请求信号HRQ CPU也可以发出应答信号：HLDA
DMA接口中还有一个中断机构：用于数据传输完后，对后续的工作进行处理，也就是说WC=0的时候，表示传输结束 =0其实是因为溢出了，会向中断机构发出溢出信号  中断机构置为1  像CPU发出中断请求，CPU做数据传输后的处理
![Pasted image 20241123203217.png|500](/img/user/accessory/Pasted%20image%2020241123203217.png)

### DMA的工作方式
#### DMA的传送过程
预处理、数据传送、后处理
预处理
	通过几条输入输出指令预置如下信息
	- 输入or输出：传输方向
	- 设备地址-> DMA的DAR
	- 主存的地址  -> DMA的AR
	- 传送字数  -> DMA的WC
	![Pasted image 20241124104411.png|200](/img/user/accessory/Pasted%20image%2020241124104411.png)
	我们看到CPU除了执行输入输出指令  将 DMA接口中的寄存器预设之外，之后的工作CPU和DMA接口的工作是完全并行的

数据传送的示意图
![Pasted image 20241124104548.png|300](/img/user/accessory/Pasted%20image%2020241124104548.png)
先看CPU有没有占用总线和内存的使用权  如果占用  DMA只能等
如果允许传送
- 主存地址送到总线：AR
- DMA控制逻辑 控制  进行一个字的传输
- 修改 主存地址  和 字计数器  都是+1

如果结束 申请程序中断 进入后处理
整个过程
![Pasted image 20241124105003.png|300](/img/user/accessory/Pasted%20image%2020241124105003.png)
以输入为例：
1. 数据从外部设备送到br
2. 设备通过设备请求信号通知DMA控制逻辑准备好了
3. DMA控制逻辑通过总线向CPU提出总线和主存的占用请求：HRQ
4. CPU在允许的情况下会给出应答，CPU会放弃对总线的占用和对主存的占用
5. AR给出存或者是取的地址
6. DMA控制逻辑给设备应答信号DACK 告诉设备已经开始了数据传输
7. BR将数据送到数据总线上 同时 更改AR和WC的值
8. WC溢出  表面完成了 送给中断机构 参加中断排队
![Pasted image 20241125123614.png|500](/img/user/accessory/Pasted%20image%2020241125123614.png)
数据的输出过程：
1. BR中的数据传输到设备 传输出去
2. 设备告知DMA控制逻辑 BR为空 没东西拿了
3. DMA控制器向cpu发出内存和总线的控制请求
4. CPU在允许的时候给出应答信号 内存和总线的控制权交给了DMA控制逻辑
5. AR给出要访问的内存单元的地址
6. DMA给设备应答  告诉设备开始了新的传输
7. 主存的内容会再次写入到数据缓冲寄存器   修改AR和WC
8. 判断传输是否结束    循环 or  退出
9. 退出的条件：WC溢出   溢出信号 传到 中断机构 中断机构发出中断请求 进行后处理
![Pasted image 20241125162150.png|500](/img/user/accessory/Pasted%20image%2020241125162150.png)
#### 后处理
校验送入主存的数是否正确
是否继续使用DMA
测试传输过程是否正确，错则转诊断程序



### DMA接口与系统的连接方式
1. 具有公共请求的DMA请求
	![Pasted image 20241125162550.png|500](/img/user/accessory/Pasted%20image%2020241125162550.png)
	所有DMA接口共享一条请求线 ---->  CPU
	DMA接口串联在一起  有顺序  越靠近CPU 优先级越高
2. 独立的DMA请求
	![Pasted image 20241125162933.png|400](/img/user/accessory/Pasted%20image%2020241125162933.png)
	每一个接口都有独立的DMA请求和请求信号
	排队工作在CPU内部完成


### DMA接口的类型
1. 选择型
	物理上：连接多个设备
	逻辑上只允许一个设备
	![Pasted image 20241125163213.png|400](/img/user/accessory/Pasted%20image%2020241125163213.png)
	只有一套电路
	CPU要设置成这个接口的值  其他接口没法使用
2. 多路型
	在物理上 连接 多个设备
	在逻辑上 允许连接 多个 设备
	但是真正传输的也只有一个设备和内存之间
	但是数据准备可以有多个数据准备
	![Pasted image 20241125163610.png|400](/img/user/accessory/Pasted%20image%2020241125163610.png)
	这是通道：通道事实上是一种DMA处理器，也是一种DMA接口
	![Pasted image 20241125164247.png|500](/img/user/accessory/Pasted%20image%2020241125164247.png)
	数据提前准备好了 就相应一下  但是每次只能响应一个 而且是速度快的优先级高